# 第二章 操作系统的硬件环境
## 2.1 中央处理器（cpu
    
    操作系统作为一个程序需要在处理器上执行。
    计算机拥有单个处理机-->单级系统
    计算机拥有多个处理机-->多处理器系统
### 2.1.1 CPU的构成与基本工作方式
    
    cpu构成：
        运算器：实现指令中的算术和逻辑运算
        控制器：负责控制程序运行的流程，包括取指令，维护cpu状态，cpu与内存的交互等等
        一系列的寄存器：指令在cpu内部做处理的过程中暂存数据，地址以及指令信息的存储设备，
                        在计算机存储系统中拥有最快的速度
        高速缓存：处于CPU和物理内存之间，一般由控制器中内存管理单元管理，访问速度快于内存低于
                寄存器，利用程序局部性原理使得告诉指令处理和低速内存访问得以匹配
    
1，处理器中的寄存器
    
    用户可见寄存器
        数据寄存器
        地址寄存器
        条件码寄存器
        
    控制和状态寄存器
        程序计数器：记录将要取出的指令的地址
        指令寄存器：包含最近取出的指令
        程序状态字：记录处理器的运行模式信息等
2，指令执行的基本过程
    
         <--取指周期<--------执行周期--
         |                             |
    开始---->取下一条指令---->执行指令---->停止
    
    五种指令类型：
        访问存储器指令
        I/O指令
        算术逻辑指令
        控制转移指令
        处理器控制指令
### 2.1.2 特权指令和非特权指令
    
    特权指令:指令系统中只能由操作系统执行的指令
    非特权指令：用户程序只能使用非特权指令
### 2.1.3 处理器的状态
    
    管态：操作系统管理程序运行的状态，具有较高的特权级别，又称特权态
    目态：指用户程序运行时的状态，具有较低的特权级别，又称普通态
    
    R0->R3特权能力依次降低
### 2.1.4 程序状态字PSW
    
    用一个专门的寄存器指示处理器的状态，称为程序状态字
    
    程序状态字通常包括以下状态代码：
        CPU的工作状态码：说明是管态还是目态
        条件码：反应指令执行后的结果特征
        中断屏蔽码：指出是否允许中断
        
    不同机器的状态字格式及信息
        
            M68000程序状态字
        
        15 14 13 12 11 10  9 8  7 6 5 4 3 2 1 0
        T     S        I2 I1 I0       X N Z V C
        
        C:进位标志位
        V:溢出标志位
        Z：结果为零标志位
        N：结果为负标志位
        I0-I2:三位中断屏蔽位
        S：CPU状态标志位，1：管态，0：目态
        T：陷阱(Trap)状态标志位
        
        
            Pentium 系列程序状态字
        
        22      ...             ..                            3 2  1 0
        ID  VIP VIF AC VM RF 0 NT IOPL OF DF IF TF SF ZF 0 AF 0 PF 1 CF
        
        CF：进位标志位
        ZF：结果为零标志位
        SF：符号标志位
        OF：溢出标志位
        TF：陷阱标志位
        IF：中断屏蔽标志位
        VIF：虚拟中断标志位
        VIP：虚拟中断待决定标志位
        IPOL：IO特权级别
        
## 2.2 存储系统
### 2.2.1 存储器的类型
    
    读写性存储器：也称为随机访问存储器(RAM),主要用于随机存取的程序和相关数据
    只读性存储器(ROM)：更多的还有，PROM:可编程只读存储器,EPROM：可擦写可编程只读存储器，
                紫外线照射擦除
### 2.2.2 存储器的层次结构
    
    层次化的存储体系结构
            
            寄存器               在处理器内
            高速缓存             在处理器内
            内存储器
            磁盘存储器
            磁带机 | 光盘存储器
            
    关键点：程序的存储访问局部性原理。
        程序段在重复存取相同的指令集合时，一段时间后，使用到的代码和数据的集合会改变，
        但在较短的时间内他们能稳定地保持在一个存储器的局部区域内，处理器也主要和这个
        存储器的这个局部打交道
### 2.2.3 存储分块
    
    存储器最小单位为"二进位"，包含信息为0或1
    存储器最小编址单是字节，一个字节包含8个二进位，2个字节称位一个字，4个字节称位双字，
    1024个字节称位1KB
    
    为了简化对存储器的分配和管理，把存储器分成块，以块为最小单位进行分配，
    这样的块有时被称为一个物理页page
### 2.2.4 存储保护
    
    保护数据不被有意或无意的破坏，从而造成系统崩溃
    
    界地址寄存器(界限寄存器)：设置一对界限寄存器来存放该数据在内存中的上限和下限地址，
                    访问时判断是否越界
    存储键：为内存块设置一个唯一的存储键，当cpu访问内存时，都将该内村块的存储键与PSW中的钥匙
            进行比较，判断是否匹配
## 2.3 缓冲技术
    
    缓冲区是硬件设备之间进行数据传输时专门用来暂存这些数据的一个存储区域
    缓冲技术：解决部件之间速度不匹配的问题
    
为什么设置缓冲暂存数据
    
    CPU处理数据速度与设备传输数据速度不匹配，用缓冲区缓解速度矛盾

多Cache技术
    
    Cache 是离CPU最近的高速缓存，能使CPU快速访问经常使用到的数据
    
            CPU     <---->     Cache   <---->   内存
            
                    字传送              块传送
## 2.4 中断技术
### 2.4.1 中断的概念
1，什么是中断
    
    中断：指计算机在执行期间，系统内或系统外发生异步事件，使得CPU暂时中止当前正在执行的程序
        转而去执行相应的事件处理程序，待处理完毕后又返回原来被中断处继续执行或调度新的进程
        执行的过程
    
    中断源：引起中断的事件
    中断请求：中断源向处理器发出的请求信号
    中断处理程序：处理中断事件的那段程序
    中断断点：发生中断时正在执行的程序的暂停点
    中断响应：处理器暂停当前程序转而处理中断的过程
    中断返回：中断处理结束之后恢复原来的程序的执行
    中断字：一个计算机系统提供的中断源的有序集合一般被称为中断字
    
    中断的作用
        能充分发挥处理器的使用效率
        提高系统的实时能力
2，中断的分类
    
    不同系统根据中断源的不同，有不同的划分
    
    微机中，中断的划分：
        程序中断
        软件中断
        时钟中断
        I/O中断
        硬件失效中断
    
    根据中断是否可屏蔽：
        可屏蔽中断
        不可屏蔽中断
    
    根据中断产生的来源：
        硬中断
            外中断
            内中断
        软中断
        
    根据中断被激发的手段
        强迫性中断
        自愿性中断
        
    等等
### 2.4.2 中断系统
    
    中断系统：现代计算机核心机制之一，使得计算机更好的发挥功用
    中断装置：负责捕获中断源发出的中断请求，并以一定的方式响应中断源，然后将处理器的控制权
             移交给特定的中断处理程序。
    中断处理程序：负责辨别中断类型斌根据请求作出相应操作
    
### 2.4.3 中断逻辑与中断寄存器
### 2.4.4 中断优先级和中断屏蔽
    
    中断优先级：cpu接收中断优先级最高的中断
    
    中断屏蔽：主机可以允许或者禁止某些类比的中断的响应，对于被禁止的中断，有些可以继续响应，
            有些被简单的丢弃。
### 2.4.5 中断响应
    
    中断响应由硬件完成，通过交换中断向量引出中断处理程序
    
    CPU响应中断的三个问题：
        响应的时机
        响应的条件
        中断源的识别
    
    中断向量表
### 2.4.6 中断处理
1，中断处理的一般过程
    
    1，简单中断处理
        
        a.设备给处理器发了一个中断信号
        b.处理器处理完当前指令后响应中断，延迟很短
        c.处理器处理完当前指令后监测到中断，判断出中断来源并向发送中断的设备发送了确认中断
        信号，确认信号使得该设备将中断信号恢复到一般状态
        d.处理器开始为软件处理中断做准备：保存中断点的程序执行上下文环境(中断处理后从中断点
        恢复被中断程序执行的必要信息)，通常包括程序状态字PSW,程序计数器PC中的下一条指令的位置
        一些寄存器的值，他们通常保存在系统堆栈中，处理器状态切换到管态
        e.处理器根据中断源查询中断向量表，获得与该中断相联系的处理程序入口地址，并将PC置成该
        地址，处理器开始一个新的指令周期，结果是控制住转移到中断处理程序。
        f.中断处理程序开始工作，其中包括检查I/O相关的状态信息，操纵I/O设备或者在设备和内存
        之间传送数据等
        g.中断处理结束时，处理器检测到中断返回指令，从系统堆栈中恢复被中断程序的上下文坏境，
        处理器状态恢复成原来的状态
        h.PSW和PC被恢复成中断前的值，处理器开始一个新的指令周期，中断处理结束
        
        处理过程如下：
            
            
                硬件                        软件
        
        硬件设备产生一个中断        中断处理程序处理剩余状态信息
                |                               |
        处理器结束当前指令的执行    中断处理程序处理中断
                |                               |
        处理器发送中断应答信号      恢复被中断程序的上下文环境
                |                               |
        处理器将PC和PSW压入栈       恢复老的PSW和PC的值
                |
        根据中断设置加载新的PC
    
    2，多个中断的处理
        
        如果一个中断的处理过程中有发生了中断，那么将引起多个中断处理问题，两种策略处理
        
        第一种方法：
            当处理一个中断时禁止中断，此时系统对任何新发生的中断置之不理，在这期间发生的中断
            都将保持挂起状态。当处理器再次允许中断时，这个新的中断信号会被处理器检测到并处理
        
        第二种方法:
            中断按照优先度分级，允许较高的优先级中断打断优先级较低的中断处理过程。
            产生中断处理嵌套。
        
2，几种典型中断的处理
    
    a.I/O中断
    b.时钟中断：计算机系统多道处理能力的重要推动力
        维护软件时钟
        处理器时间调度
        控制系统定时任务
        实时处理
    c.硬件故障中断
    d.程序性中断
    e.系统服务请求(自愿性中断)
        
        
## 2.5 I/O 技术
### 2.5.1 程序控制I/O技术

    通过处理器提供相关的I/O指令实现。
        控制指令
        状态指令
        数据传送指令
        
    缺陷：处理器必须关注I/O处理单元的状态，因而会耗费大量时间轮询以获得这个信息，
    严重降低了系统性能
### 2.5.2 中断驱动I/O技术

    让处理器从轮询任务中解放出来
    具体做法：当I/O处理单元准备好与设备交互的时候，通过物理信号通知处理器，即中断处理器
    
### 2.5.3 直接存储器访问(DMA)技术
    
    通过系统总线中一个独立控制单元--DMA控制器，自动的控制成块的数据在内存和I/O单元
    之间的传送
### 2.5.4 通道

    通道是独立于中央处理器的，专门负责数据I/O传输工作的处理单元，它对外设实现统一管理，
    代替CPU对I/O操作进行控制，是CPU和外设可以并行工作。所以通道又被称为I/O处理机。
## 2.6 时钟
    
    时钟的作用：
    
    1，在多道处理程序运行环境中，为系统发现一个陷入死循环的作业
    2，在分时系统中，用间隔时钟来实现，作业间按时间片轮转
    3，在实时系统中，按要求的时间间隔输出正确的时间信号给一个实时的控制设备
    4，定时唤醒哪些要求延迟执行的各个外部事件
    5，记录用户使用各种设备的时间和记录某外部事件发生的时间间隔
    6，记录用户和系统所需要的绝对时间
    绝对时钟：记录当前的时间
    间隔时钟：每经过一个单位时间，时钟的值减1，为零时，触发中断
## 2.7 Linux 的中断处理
## 习题